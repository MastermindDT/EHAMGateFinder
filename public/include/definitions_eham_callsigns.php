<?php

class Callsigns_EHAM {
	private static $extraCallsignsFile = 'data-callsigns.txt';
	private static $retention = 900; // 15 minutes

	private static $KLM = array(
		'KLM10B' => 'KL 1210',
		'KLM10M' => 'KL 1208',
		'KLM11B' => 'KL 1127',
		'KLM11M' => 'KL 1705',
		'KLM11P' => 'KL 1227',
		'KLM11Y' => 'KL 1157',
		'KLM12H' => 'KL 1704',
		'KLM12P' => 'KL 1228',
		'KLM12V' => 'KL 1128',
		'KLM12Y' => 'KL 1158',
		'KLM13G' => 'KL 1129',
		'KLM13N' => 'KL 1059',
		'KLM13T' => 'KL 1703',
		'KLM13W' => 'KL 1811',
		'KLM14N' => 'KL 1060',
		'KLM14W' => 'KL 1812',
		'KLM14X' => 'KL 1130',
		'KLM14Y' => 'KL 1160',
		'KLM15E' => 'KL 1131',
		'KLM15L' => 'KL 1505',
		'KLM15P' => 'KL 1233',
		'KLM15W' => 'KL 1535',
		'KLM15X' => 'KL 1537',
		'KLM16L' => 'KL 1506',
		'KLM16P' => 'KL 1234',
		'KLM16V' => 'KL 1132',
		'KLM16X' => 'KL 1530',
		'KLM17' => 'KL 0651',
		'KLM17C' => 'KL 1121',
		'KLM17G' => 'KL 1133',
		'KLM17M' => 'KL 1701',
		'KLM18' => 'KL 0652',
		'KLM18C' => 'KL 1702',
		'KLM18M' => 'KL 1146',
		'KLM18S' => 'KL 1882',
		'KLM18X' => 'KL 1134',
		'KLM18Y' => 'KL 1884',
		'KLM19B' => 'KL 1139',
		'KLM19J' => 'KL 1147',
		'KLM19M' => 'KL 1109',
		'KLM19P' => 'KL 1243',
		'KLM19T' => 'KL 1699',
		'KLM19U' => 'KL 1973',
		'KLM20H' => 'KL 1700',
		'KLM20M' => 'KL 1110',
		'KLM20P' => 'KL 1244',
		'KLM213' => 'KL 0681',
		'KLM214' => 'KL 0682',
		'KLM21J' => 'KL 1221',
		'KLM21L' => 'KL 1053',
		'KLM21U' => 'KL 1807',
		'KLM21V' => 'KL 1863',
		'KLM22J' => 'KL 1618',
		'KLM22L' => 'KL 1054',
		'KLM22T' => 'KL 1818',
		'KLM22U' => 'KL 1808',
		'KLM23' => 'KL 0661',
		'KLM23P' => 'KL 1223',
		'KLM23Y' => 'KL 1861',
		'KLM24' => 'KL 0662',
		'KLM24J' => 'KL 1862',
		'KLM24P' => 'KL 1224',
		'KLM24X' => 'KL 1624',
		'KLM255' => 'KL 0621',
		'KLM256' => 'KL 0622',
		'KLM25P' => 'KL 1245',
		'KLM25R' => 'KL 1423',
		'KLM26B' => 'KL 1582',
		'KLM26P' => 'KL 1246',
		'KLM26R' => 'KL 1424',
		'KLM27G' => 'KL 1903',
		'KLM27Y' => 'KL 1855',
		'KLM27Z' => 'KL 1217',
		'KLM281' => 'KL 0605',
		'KLM282' => 'KL 0606',
		'KLM28K' => 'KL 1340',
		'KLM28M' => 'KL 1904',
		'KLM28Z' => 'KL 1218',
		'KLM29L' => 'KL 1477',
		'KLM29T' => 'KL 1879',
		'KLM29W' => 'KL 0963',
		'KLM29Y' => 'KL 1857',
		'KLM30K' => 'KL 1342',
		'KLM30W' => 'KL 0964',
		'KLM30Y' => 'KL 1858',
		'KLM31' => 'KL 0691',
		'KLM32' => 'KL 0692',
		'KLM32D' => 'KL 1148',
		'KLM32S' => 'KL 1344',
		'KLM32W' => 'KL 1440',
		'KLM33G' => 'KL 1441',
		'KLM33H' => 'KL 1623',
		'KLM33J' => 'KL 1193',
		'KLM33N' => 'KL 1345',
		'KLM34G' => 'KL 1442',
		'KLM34K' => 'KL 1346',
		'KLM34Z' => 'KL 1852',
		'KLM35E' => 'KL 1171',
		'KLM35W' => 'KL 1347',
		'KLM36L' => 'KL 1736',
		'KLM36S' => 'KL 1348',
		'KLM37A' => 'KL 1419',
		'KLM37G' => 'KL 1445',
		'KLM37P' => 'KL 1229',
		'KLM37Y' => 'KL 1883',
		'KLM38G' => 'KL 1446',
		'KLM38H' => 'KL 1650',
		'KLM38P' => 'KL 1230',
		'KLM39B' => 'KL 1653',
		'KLM39E' => 'KL 1169',
		'KLM39N' => 'KL 1349',
		'KLM39Z' => 'KL 1443',
		'KLM40B' => 'KL 1654',
		'KLM40E' => 'KL 1170',
		'KLM40M' => 'KL 1470',
		'KLM40Z' => 'KL 1444',
		'KLM41H' => 'KL 1969',
		'KLM41U' => 'KL 1267',
		'KLM42G' => 'KL 1478',
		'KLM42U' => 'KL 1268',
		'KLM43H' => 'KL 1327',
		'KLM43M' => 'KL 1473',
		'KLM43Z' => 'KL 1163',
		'KLM44A' => 'KL 1708',
		'KLM44M' => 'KL 1474',
		'KLM45C' => 'KL 1791',
		'KLM45F' => 'KL 1343',
		'KLM45J' => 'KL 1475',
		'KLM46C' => 'KL 1792',
		'KLM46F' => 'KL 1476',
		'KLM47' => 'KL 0611',
		'KLM47B' => 'KL 1953',
		'KLM47V' => 'KL 1793',
		'KLM48' => 'KL 0612',
		'KLM48B' => 'KL 1954',
		'KLM48V' => 'KL 1794',
		'KLM48Y' => 'KL 1924',
		'KLM49C' => 'KL 1797',
		'KLM49J' => 'KL 1481',
		'KLM49L' => 'KL 1959',
		'KLM49W' => 'KL 1925',
		'KLM50C' => 'KL 1798',
		'KLM50G' => 'KL 1952',
		'KLM50L' => 'KL 1960',
		'KLM50V' => 'KL 1926',
		'KLM51R' => 'KL 1063',
		'KLM51T' => 'KL 1835',
		'KLM51X' => 'KL 1825',
		'KLM51Y' => 'KL 1927',
		'KLM52F' => 'KL 1362',
		'KLM52R' => 'KL 1064',
		'KLM52X' => 'KL 1826',
		'KLM52Y' => 'KL 1928',
		'KLM53L' => 'KL 1201',
		'KLM53M' => 'KL 1931',
		'KLM53W' => 'KL 1363',
		'KLM54M' => 'KL 1932',
		'KLM54W' => 'KL 1364',
		'KLM55T' => 'KL 1355',
		'KLM56B' => 'KL 1156',
		'KLM56L' => 'KL 1962',
		'KLM56T' => 'KL 1356',
		'KLM57C' => 'KL 1957',
		'KLM57M' => 'KL 1211',
		'KLM57W' => 'KL 1933',
		'KLM58C' => 'KL 1958',
		'KLM58H' => 'KL 1880',
		'KLM58R' => 'KL 1372',
		'KLM58V' => 'KL 1934',
		'KLM59Z' => 'KL 1937',
		'KLM61R' => 'KL 1375',
		'KLM62R' => 'KL 1376',
		'KLM63L' => 'KL 1635',
		'KLM63T' => 'KL 1313',
		'KLM65F' => 'KL 1365',
		'KLM65G' => 'KL 1449',
		'KLM65L' => 'KL 1601',
		'KLM66F' => 'KL 1366',
		'KLM67S' => 'KL 1891',
		'KLM67Z' => 'KL 1603',
		'KLM68Z' => 'KL 1604',
		'KLM69J' => 'KL 1887',
		'KLM69M' => 'KL 1609',
		'KLM69W' => 'KL 1551',
		'KLM70J' => 'KL 1888',
		'KLM71H' => 'KL 1117',
		'KLM71K' => 'KL 1175',
		'KLM73J' => 'KL 1677',
		'KLM73N' => 'KL 1311',
		'KLM74G' => 'KL 1174',
		'KLM74N' => 'KL 1312',
		'KLM74S' => 'KL 1692',
		'KLM75K' => 'KL 1675',
		'KLM76T' => 'KL 1676',
		'KLM77C' => 'KL 1911',
		'KLM77M' => 'KL 1435',
		'KLM78C' => 'KL 1912',
		'KLM78E' => 'KL 1540',
		'KLM79F' => 'KL 1431',
		'KLM79G' => 'KL 1379',
		'KLM79K' => 'KL 1673',
		'KLM79X' => 'KL 1125',
		'KLM80L' => 'KL 1432',
		'KLM80T' => 'KL 1674',
		'KLM80X' => 'KL 1126',
		'KLM81J' => 'KL 1429',
		'KLM81V' => 'KL 1777',
		'KLM82J' => 'KL 1430',
		'KLM82V' => 'KL 1778',
		'KLM83F' => 'KL 1421',
		'KLM83K' => 'KL 1671',
		'KLM83R' => 'KL 1875',
		'KLM84F' => 'KL 1422',
		'KLM84R' => 'KL 1876',
		'KLM85J' => 'KL 1665',
		'KLM86N' => 'KL 1666',
		'KLM87B' => 'KL 1779',
		'KLM88B' => 'KL 1780',
		'KLM88J' => 'KL 1776',
		'KLM88T' => 'KL 1664',
		'KLM89S' => 'KL 1081',
		'KLM90J' => 'KL 1420',
		'KLM90K' => 'KL 1672',
		'KLM90S' => 'KL 1082',
		'KLM91Z' => 'KL 1097',
		'KLM92Z' => 'KL 1072',
		'KLM93V' => 'KL 1781',
		'KLM94G' => 'KL 1782',
		'KLM95T' => 'KL 1303',
		'KLM95X' => 'KL 1783',
		'KLM96B' => 'KL 1784',
		'KLM96H' => 'KL 1304',
		'KLM96L' => 'KL 1796',
		'KLM98C' => 'KL 1300',
		'KLM99X' => 'KL 1789',
		'KLM281' => 'KL 0605',
		'KLM282' => 'KL 0606',
		'KLM47' => 'KL 0611',
		'KLM48' => 'KL 0612',
		'KLM255' => 'KL 0621',
		'KLM256' => 'KL 0622',
		'KLM17' => 'KL 0651',
		'KLM18' => 'KL 0652',
		'KLM23' => 'KL 0661',
		'KLM24' => 'KL 0662',
		'KLM213' => 'KL 0681',
		'KLM214' => 'KL 0682',
		'KLM31' => 'KL 0691',
		'KLM32' => 'KL 0692',
		'KLM29W' => 'KL 0963',
		'KLM30W' => 'KL 0964',
		'KLM21L' => 'KL 1053',
		'KLM22L' => 'KL 1054',
		'KLM13N' => 'KL 1059',
		'KLM14N' => 'KL 1060',
		'KLM51R' => 'KL 1063',
		'KLM52R' => 'KL 1064',
		'KLM92Z' => 'KL 1072',
		'KLM89S' => 'KL 1081',
		'KLM90S' => 'KL 1082',
		'KLM91Z' => 'KL 1097',
		'KLM19M' => 'KL 1109',
		'KLM20M' => 'KL 1110',
		'KLM71H' => 'KL 1117',
		'KLM17C' => 'KL 1121',
		'KLM79X' => 'KL 1125',
		'KLM80X' => 'KL 1126',
		'KLM11B' => 'KL 1127',
		'KLM12V' => 'KL 1128',
		'KLM13G' => 'KL 1129',
		'KLM14X' => 'KL 1130',
		'KLM15E' => 'KL 1131',
		'KLM16V' => 'KL 1132',
		'KLM17G' => 'KL 1133',
		'KLM18X' => 'KL 1134',
		'KLM19B' => 'KL 1139',
		'KLM18M' => 'KL 1146',
		'KLM19J' => 'KL 1147',
		'KLM32D' => 'KL 1148',
		'KLM56B' => 'KL 1156',
		'KLM11Y' => 'KL 1157',
		'KLM12Y' => 'KL 1158',
		'KLM14Y' => 'KL 1160',
		'KLM43Z' => 'KL 1163',
		'KLM39E' => 'KL 1169',
		'KLM40E' => 'KL 1170',
		'KLM35E' => 'KL 1171',
		'KLM74G' => 'KL 1174',
		'KLM71K' => 'KL 1175',
		'KLM33J' => 'KL 1193',
		'KLM53L' => 'KL 1201',
		'KLM10M' => 'KL 1208',
		'KLM10B' => 'KL 1210',
		'KLM57M' => 'KL 1211',
		'KLM27Z' => 'KL 1217',
		'KLM28Z' => 'KL 1218',
		'KLM21J' => 'KL 1221',
		'KLM23P' => 'KL 1223',
		'KLM24P' => 'KL 1224',
		'KLM11P' => 'KL 1227',
		'KLM12P' => 'KL 1228',
		'KLM37P' => 'KL 1229',
		'KLM38P' => 'KL 1230',
		'KLM15P' => 'KL 1233',
		'KLM16P' => 'KL 1234',
		'KLM19P' => 'KL 1243',
		'KLM20P' => 'KL 1244',
		'KLM25P' => 'KL 1245',
		'KLM26P' => 'KL 1246',
		'KLM41U' => 'KL 1267',
		'KLM42U' => 'KL 1268',
		'KLM98C' => 'KL 1300',
		'KLM95T' => 'KL 1303',
		'KLM96H' => 'KL 1304',
		'KLM73N' => 'KL 1311',
		'KLM74N' => 'KL 1312',
		'KLM63T' => 'KL 1313',
		'KLM43H' => 'KL 1327',
		'KLM28K' => 'KL 1340',
		'KLM30K' => 'KL 1342',
		'KLM45F' => 'KL 1343',
		'KLM32S' => 'KL 1344',
		'KLM33N' => 'KL 1345',
		'KLM34K' => 'KL 1346',
		'KLM35W' => 'KL 1347',
		'KLM36S' => 'KL 1348',
		'KLM39N' => 'KL 1349',
		'KLM55T' => 'KL 1355',
		'KLM56T' => 'KL 1356',
		'KLM52F' => 'KL 1362',
		'KLM53W' => 'KL 1363',
		'KLM54W' => 'KL 1364',
		'KLM65F' => 'KL 1365',
		'KLM66F' => 'KL 1366',
		'KLM58R' => 'KL 1372',
		'KLM61R' => 'KL 1375',
		'KLM62R' => 'KL 1376',
		'KLM79G' => 'KL 1379',
		'KLM37A' => 'KL 1419',
		'KLM90J' => 'KL 1420',
		'KLM83F' => 'KL 1421',
		'KLM84F' => 'KL 1422',
		'KLM25R' => 'KL 1423',
		'KLM26R' => 'KL 1424',
		'KLM81J' => 'KL 1429',
		'KLM82J' => 'KL 1430',
		'KLM79F' => 'KL 1431',
		'KLM80L' => 'KL 1432',
		'KLM77M' => 'KL 1435',
		'KLM32W' => 'KL 1440',
		'KLM33G' => 'KL 1441',
		'KLM34G' => 'KL 1442',
		'KLM39Z' => 'KL 1443',
		'KLM40Z' => 'KL 1444',
		'KLM37G' => 'KL 1445',
		'KLM38G' => 'KL 1446',
		'KLM65G' => 'KL 1449',
		'KLM40M' => 'KL 1470',
		'KLM43M' => 'KL 1473',
		'KLM44M' => 'KL 1474',
		'KLM45J' => 'KL 1475',
		'KLM46F' => 'KL 1476',
		'KLM29L' => 'KL 1477',
		'KLM42G' => 'KL 1478',
		'KLM49J' => 'KL 1481',
		'KLM15L' => 'KL 1505',
		'KLM16L' => 'KL 1506',
		'KLM16X' => 'KL 1530',
		'KLM15W' => 'KL 1535',
		'KLM15X' => 'KL 1537',
		'KLM78E' => 'KL 1540',
		'KLM69W' => 'KL 1551',
		'KLM26B' => 'KL 1582',
		'KLM65L' => 'KL 1601',
		'KLM67Z' => 'KL 1603',
		'KLM68Z' => 'KL 1604',
		'KLM69M' => 'KL 1609',
		'KLM22J' => 'KL 1618',
		'KLM33H' => 'KL 1623',
		'KLM24X' => 'KL 1624',
		'KLM63L' => 'KL 1635',
		'KLM38H' => 'KL 1650',
		'KLM39B' => 'KL 1653',
		'KLM40B' => 'KL 1654',
		'KLM88T' => 'KL 1664',
		'KLM85J' => 'KL 1665',
		'KLM86N' => 'KL 1666',
		'KLM83K' => 'KL 1671',
		'KLM90K' => 'KL 1672',
		'KLM79K' => 'KL 1673',
		'KLM80T' => 'KL 1674',
		'KLM75K' => 'KL 1675',
		'KLM76T' => 'KL 1676',
		'KLM73J' => 'KL 1677',
		'KLM74S' => 'KL 1692',
		'KLM19T' => 'KL 1699',
		'KLM20H' => 'KL 1700',
		'KLM17M' => 'KL 1701',
		'KLM18C' => 'KL 1702',
		'KLM13T' => 'KL 1703',
		'KLM12H' => 'KL 1704',
		'KLM11M' => 'KL 1705',
		'KLM44A' => 'KL 1708',
		'KLM36L' => 'KL 1736',
		'KLM88J' => 'KL 1776',
		'KLM81V' => 'KL 1777',
		'KLM82V' => 'KL 1778',
		'KLM87B' => 'KL 1779',
		'KLM88B' => 'KL 1780',
		'KLM93V' => 'KL 1781',
		'KLM94G' => 'KL 1782',
		'KLM95X' => 'KL 1783',
		'KLM96B' => 'KL 1784',
		'KLM99X' => 'KL 1789',
		'KLM45C' => 'KL 1791',
		'KLM46C' => 'KL 1792',
		'KLM47V' => 'KL 1793',
		'KLM48V' => 'KL 1794',
		'KLM96L' => 'KL 1796',
		'KLM49C' => 'KL 1797',
		'KLM50C' => 'KL 1798',
		'KLM21U' => 'KL 1807',
		'KLM22U' => 'KL 1808',
		'KLM13W' => 'KL 1811',
		'KLM14W' => 'KL 1812',
		'KLM22T' => 'KL 1818',
		'KLM51X' => 'KL 1825',
		'KLM52X' => 'KL 1826',
		'KLM51T' => 'KL 1835',
		'KLM34Z' => 'KL 1852',
		'KLM27Y' => 'KL 1855',
		'KLM29Y' => 'KL 1857',
		'KLM30Y' => 'KL 1858',
		'KLM23Y' => 'KL 1861',
		'KLM24J' => 'KL 1862',
		'KLM21V' => 'KL 1863',
		'KLM83R' => 'KL 1875',
		'KLM84R' => 'KL 1876',
		'KLM29T' => 'KL 1879',
		'KLM58H' => 'KL 1880',
		'KLM18S' => 'KL 1882',
		'KLM37Y' => 'KL 1883',
		'KLM18Y' => 'KL 1884',
		'KLM69J' => 'KL 1887',
		'KLM70J' => 'KL 1888',
		'KLM67S' => 'KL 1891',
		'KLM27G' => 'KL 1903',
		'KLM28M' => 'KL 1904',
		'KLM77C' => 'KL 1911',
		'KLM78C' => 'KL 1912',
		'KLM48Y' => 'KL 1924',
		'KLM49W' => 'KL 1925',
		'KLM50V' => 'KL 1926',
		'KLM51Y' => 'KL 1927',
		'KLM52Y' => 'KL 1928',
		'KLM53M' => 'KL 1931',
		'KLM54M' => 'KL 1932',
		'KLM57W' => 'KL 1933',
		'KLM58V' => 'KL 1934',
		'KLM59Z' => 'KL 1937',
		'KLM50G' => 'KL 1952',
		'KLM47B' => 'KL 1953',
		'KLM48B' => 'KL 1954',
		'KLM57C' => 'KL 1957',
		'KLM58C' => 'KL 1958',
		'KLM49L' => 'KL 1959',
		'KLM50L' => 'KL 1960',
		'KLM56L' => 'KL 1962',
		'KLM41H' => 'KL 1969',
		'KLM19U' => 'KL 1973'
	);

	static function findFlightnumber($callsign) {
		$getFlightnumber = file_get_contents('http://planefinder.net/data/endpoints/search_ajax.php?searchText=' . $callsign);
		$getFlightnumber = json_decode($getFlightnumber, true);

		if($getFlightnumber) {
			foreach($getFlightnumber['flights'] as $data) {
				if($data['subtitle'] == $callsign) {
					return preg_replace('/^([A-Z]{2,3})/', '$1 ', $data['title']);
				}
			}
		}

		return false;
	}

	static function getCallsignsFromFile() {
		$data = file_get_contents(self::$extraCallsignsFile);
		$data = json_decode($data, true);

		return $data;
	}

	static function addFlightnumber($callsign, $flightnumber) {
		$data = self::getCallsignsFromFile();
		$data[$callsign]['flightnumber'] = $flightnumber;
		$data[$callsign]['added'] = time();

		file_put_contents(self::$extraCallsignsFile, json_encode($data));

		return $data[$callsign];
	}

	static function convertAlphanumeric($callsign) {
		$defaultCallsigns = self::$KLM;
		$storedCallsigns = self::getCallsignsFromFile();

		if(array_key_exists($callsign, $defaultCallsigns)) {
			return $defaultCallsigns[$callsign];
		}

		if(array_key_exists($callsign, $storedCallsigns)) {
			$data = $storedCallsigns[$callsign];

			if($data['added'] + self::$retention < time()) {
				$findRemote = self::findFlightnumber($callsign);

				if($findRemote) {
					$data = self::addFlightnumber($callsign, $findRemote);
				}
				else {
					$data = self::addFlightnumber($callsign, $data['flightnumber']);
				}
			}

			return $data['flightnumber'];
		}
		
		$findRemote = self::findFlightnumber($callsign);
		self::addFlightnumber($callsign, $findRemote);
		
		return $findRemote;
	}
}

?>